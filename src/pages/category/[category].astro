---
import { ITEMS_PER_PAGE } from '@/consts';
import SidebarLayout from "@/layouts/SidebarLayout.astro";
import { getCollection } from "astro:content";
import type { CollectionEntry } from 'astro:content';
import BlogPostArticle from "@components/BlogPostArticle.astro";
import {excludeDrafts, sortBlogPosts} from "@/functions";
import Pagination from "@philnash/astro-pagination";

export async function getStaticPaths() {
  const posts = await getCollection('posts', excludeDrafts);
  const categories = [...new Set(posts.flatMap((p) => p.data.categories))];
  
  return categories.map(category => {
    const categoryPosts = posts.filter(p => p.data.categories.includes(category));
    const sortedPosts = sortBlogPosts(categoryPosts);
    const firstPagePosts = sortedPosts.slice(0, ITEMS_PER_PAGE);
    const totalPages = Math.ceil(sortedPosts.length / ITEMS_PER_PAGE);
    
    return {
      params: { category },
      props: { 
        category,
        posts: firstPagePosts,
        currentPage: 1,
        totalPages,
        allPosts: sortedPosts
      }
    };
  });
}

const { category, posts, currentPage, totalPages, allPosts } = Astro.props;
const pageTitle = "Category Archives: " + category.replace(/-/g, ' ');

// Create a mock page object for the Pagination component
const page = {
  data: posts,
  url: {
    current: `/category/${category}`,
    next: totalPages > 1 ? `/category/${category}/2` : undefined,
    prev: undefined
  },
  currentPage,
  lastPage: totalPages,
  size: ITEMS_PER_PAGE,
  total: allPosts.length
};
---

<SidebarLayout pageTitle={pageTitle}>
	{totalPages > 1 && (
		<div class="pagination items-center flex mb-6">
		<Pagination page={page} urlPattern={`/category/${category}/{}`} firstPageUrl={`/category/${category}`} />
		</div>
	)}
	<ul class="divide-y divide-gray-200 dark:divide-gray-700">
		{!posts.length && 'No posts found.'}
		{posts.map((post: CollectionEntry<"posts">) => <li><BlogPostArticle post={post} homepage={true}/></li>)}
	</ul>
	{totalPages > 1 && (
		<div class="pagination items-center flex">
		<Pagination page={page} urlPattern={`/category/${category}/{}`} firstPageUrl={`/category/${category}`} />
		</div>
	)}
</SidebarLayout>
